Глава 9. Архитектура микроконтроллеров 
5. Записать в разряд EEWE регистра EECR лог. «1» в течение 4-х 
машинных циклов. После установки этого разряда процессор 
пропускает 2 машинных цикла перед выполнением следующей 
инструкции. 
Второй пункт введен из-за того, что запись в EEPROM-память не может 
выполняться одновременно с записью в FLASH-память. Поэтому перед  
выполнением записи в EEPROM-память следует убедиться, что  
программирование FLASH-памяти завершено. Если в программе отсутствует загрузчик, т. 
е. микроконтроллер никогда не изменяет содержимое памяти программ, 
второй шаг может быть пропущен. 
Процесс обращения к EEPROM-памяти контролируется внутренним 
ЛС-генератором (во всех моделях, кроме ATmegal61x, для этой цели  
используется калибруемый 7?С-генератор). Соответственно, длительность цикла  
записи зависит от частоты этого генератора, напряжения питания, температуры 
и составляет 2.0...3.8 мс для моделей ATmegal61x/163x/323x и 7.5...9.0 мс для 
остальных моделей. По окончании цикла записи разряд EEWE аппарат™ 
сбрасывается, после чего программа может начать запись следующего байга. 
При записи в EEPROM могут возникнуть некоторые проблемы,  
вызванные прерываниями: 
1. При возникновении прерывания между 4-м и 5-м этапами 
описанной последовательности, запись в EEPROM будет  
сорвана, т.к. за время обработки прерывания флаг EEMWE сбросится 
в «0». 
2. Если в подпрограмме обработки прерывания, возникшего 
во время записи в EEPROM-память, также происходит  
обращение к ней, то будет изменено содержимое регистров адреса и  
данных EEPROM. В результате первая запись (прерванная) будет  
сорвана. 
Для избежания описанных проблем настоятельно рекомендуется  
запрещать все прерывания (сбрасывать бит I регистра SREG) на время  
выполнения пунктов 2...5 описанной выше последовательности. 
Ниже приведены два примера реализации функции записи в 
EEPROM-память (управление прерываниями не производится). 
Пример на ассемблере 
EEPROM_write: 
sbic EECR,EEWE ;Ждать завершения предыдущей записи 
rjmp EEPROM_write 
out EEARH,rl8 
out EEARL,rl7 /Занести адрес (rl8:rl7) в регистр адреса 
out EEDR,rl6 /Записать данные (г16) в регистр данных 
sbi EECR,EEMWE /Установить флаг EEMWE 
sbi EECR,EEWE /Начать запись в EEPROM 
ret 
-191- 
