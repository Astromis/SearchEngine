Глава 26. Самопрограммирование микроконтроллеров семейства Mega 
Обратите внимание на то, что во время записи в EEPROM-память 
изменение регистра SPMCR невозможно. Поэтому, перед тем как 
записать какое-либо значение в регистр SPMCR, рекомендуется 
дождаться сброса флага EEWE регистра EECR. 
Для адресации памяти программ при использовании команды SPM 
используется индексный регистр Z, получаемый объединением двух 
старших регистров общего назначения R30 (младший байт) и R31 
(старший байт). Поскольку память программ в микроконтроллерах 
семейства Mega имеет страничную организацию, счетчик команд 
можно условно разбить на две части. Первая часть (младшие разряды) 
адресует ячейку на странице, а вторая часть определяет страницу 
(Рис. 4.19). После запуска операции программирования содержимое 
регистра Z фиксируется и его можно использовать для других целей. 
26.3.2. Изменение памяти программ 
Изменение содержимого памяти программ осуществляется в  
следующей последовательности: 
1. Заполнение временного буфера страницы новым содержимым. 
2. Очистка страницы. 
3. Перенос содержимого буфера в память программ. 
Следует заметить, что очистка страницы может выполняться как 
после заполнения буфера, так и перед его заполнением. Однако при 
необходимости изменить только часть страницы приведенный  
порядок действий является, по понятным причинам, единственно  
возможным. В этом случае содержимое ячеек, не требующих изменения,  
сохраняется в буфере перед очисткой страницы. 
Для определения момента окончания выполнения операций можно 
либо опрашивать состояние флага SPMEN регистра SPMCR,  
дожидаясь его сброса, либо воспользоваться прерыванием «Готовность SPM». 
Это прерывание генерируется все время, пока флаг SPMEN сброшен. 
В последнем случае таблица векторов прерываний должна находиться 
в секции загрузчика, а это прерывание должно быть разрешено  
установкой флага SPMIE регистра SPMCR. 
Для стирания страницы памяти программ необходимо занести  
адрес страницы в регистр Z (секция PCPAGE), записать значение 
«хОООООИ» в регистр SPMCR и в течение четырех машинных циклов 
выполнить команду SPM. Содержимое регистров R1 и R0 при этом  
игнорируется. 
Для занесения слова команды в буфер следует загрузить адрес  
ячейки в регистр Z (секция PCWORD), а код операции — в регистры R1:RO. 
После этого необходимо записать значение «хОООООП» в регистр 
-535- 
