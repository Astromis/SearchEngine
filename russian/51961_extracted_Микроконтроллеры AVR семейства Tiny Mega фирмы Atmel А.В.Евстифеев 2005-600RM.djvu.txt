Часть 2. Микроконтроллеры семейства Mega 
Остальные выводы модуля SPI являются в этом режиме входами. А при  
подаче на вывод SS напряжения ВЫСОКОГО уровня все выводы модуля SPI 
переключаются в режим ввода данных. При этом модуль переходит в  
неактивное состояние и прием данных не производится. Как правило, в этом  
состоянии программа изменяет содержимое регистра данных. 
Следует помнить, что каждый раз, когда на вывод SS подается  
напряжение ВЫСОКОГО уровня, происходит сброс модуля SPI. Соответственно, 
если изменение состояния этого вывода произойдет во время передачи  
данных, и прием, и передача немедленно прекратятся, а передаваемый и  
принимаемый байты будут потеряны. 
Если же микроконтроллер находится в режиме «Master» (разряд MSTR 
регистра SPCR установлен в «1»), направление передачи данных через вывод 
SS определяется пользователем. Если вывод сконфигурирован как выход, 
он работает как линия вьюода общего назначения и не влияет на работу  
модуля^!. Как правило, в этом случае он используется для управления  
выводом SS микроконтроллера, работающего в режиме «Slave». 
Если же вывод сконфигурирован как вход, то для обеспечения  
нормальной работы модуля SPI, на него должно быть подано напряжение 
ВЫСОКОГО уровня. Подача на этот вход напряжения НИЗКОГО уровня 
от какой-либо внешней схемы будет воспринята модулем SPI как выбор 
данного микроконтроллера в качестве ведомого, и соответственно, начало 
передачи ему данных. Во избежание конфликта на шине модуль SPI в таких 
случаях выполняет следующие действия: 
1.Флаг MSTR регистра SPCR сбрасывается, и микроконтроллер 
переключается в режим «Slave». Как следствие, выводы MOSI и 
SCK начинают функционировать как входы. 
2. Устанавливается флаг SPIF регистра SPSR, генерируя запрос на 
прерывание от SPI. Если прерывания от SPI разрешены и флаг I 
регистра SREG установлен в «1», происходит запуск  
подпрограммы обработки прерывания. 
Таким образом, если ведущий микроконтроллер использует передачу 
данных, _управляемую прерыванием, и существует вероятность подачи 
на вход SS напряжения НИЗКОГО уровня, в подпрограмме обработки 
прерывания от SPI обязательно должна осуществляться проверка состояния 
флага MSTR. При обнаружении сброса этого флага он должен быть 
программно установлен обратно в «1» для обратного перевода  
микроконтроллера в режим «Master». 
-354- 
