Глава 17.Последовательный периферийный интерфейс SPI 
Рис. 2.107. Соединение микроконтроллеров по интерфейсу SPI 
Передача данных осуществляется следующим образом. При записи в  
регистр данных SPI ведущего микроконтроллера запускается генератор  
тактового сигнала модуля SPI, и данные начинают поразрядно выдаваться на  
вывод MOSI и соответственно поступать на вывод MOSI ведомого 
микроконтроллера. Порядок передачи разрядов данных определяется  
состоянием разряда DORD регистра SPCR. Если разряд установлен в «1»,  
первым передается младший разряд байта, если же сброшен в «О» — старший 
разряд. После выдачи последнего разряда текущего байта генератор  
тактового сигнала останавливается с одновременной установкой в «1» флага  
«Конец передачи» (SPIF). Если прерывания от модуля SPI разрешены (флаг 
SPIE регистра SPCR установлен в «1»), генерируется запрос на прерывание. 
После этого ведущий микроконтроллер может начать передачу следующего 
байта либо, подав на вход SS ведомого микроконтроллера напряжение 
ВЫСОКОГО уровня, перевести последний в состояние ожидания. 
Одновременно с передачей данных от ведущего к ведомому происходит 
передача и в обратном направлении при условии, что на входе SS ведомого 
присутствует напряжение НИЗКОГО уровня. Таким образом, в каждом 
цикле сдвига происходит обмен данными между устройствами. Аналогично 
в конце каждого цикла флаг SPIF устанавливается в «1» как в ведущем  
микроконтроллере, так и в ведомом. Принятые байты сохраняются в приемных 
буферах для дальнейшего использования. 
В модуле реализована одинарная буферизация при передаче и двойная 
при приеме. Это означает, что готовый для передачи байт данных не может 
быть записан в регистр данных SPI до окончания предыдущего цикла  
обмена. При попытке изменить содержимое регистра данных во время передачи 
устанавливается в «1» флаг WCOL регистра SPSR. Сбрасывается этот флаг 
после чтения регистра SPSR с последующим обращением к регистру 
данных SPI. 
Соответственно, при приеме данных принятый байт должен быть 
прочитан из регистра данных SPI до того, как в сдвиговый регистр поступит 
последний разряд следующего байта. В противном случае первый байт 
будет потерян. 
-351- 
