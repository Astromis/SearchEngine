Глава 26. Самопрограммирование микроконтроллеров семейства Mega 
записать в регистр SPMCR значение «xOOOlOOl» и в течение трех 
машинных циклов выполнить команду LPM. В результате выполнения 
команды содержимое выбранного байта конфигурации будет занесено 
в регистр общего назначения. Соответствие разрядов регистра  
конфигурационным ячейкам — см. Табл. 4.6. 
26.3.5. Пример реализации программы-загрузчика 
Ниже приведен пример реализации программы-загрузчика,  
осуществляющей простое копирование страницы памяти программ из ОЗУ 
в FLASH-память. Этот пример предназначен исключительно для 
иллюстрации возможностей самопрограммирования  
микроконтроллеров семейства, поэтому в нем отсутствуют некоторые элементы, 
обязательные в реальной программе. В частности, отсутствует такая 
важная вещь, как обработка ошибок. Кроме того, предполагается, что 
прерывания запрещены или что таблица векторов размещена в секции 
загрузчика. 
;Адрес 1-го байта в ОЗУ передается в указателе Y 
;Адрес 1-го байта в FLASH-памяти передается в указателе Z 
.equ PAGESIZEB = PAGESIZE*2 /Размер страницы в байтах 
.org SMALLBOOTSTART 
Write_page: 
;Стереть страницу 
ldi spmcrval, A«PGERS) | A«SPMEN) 
call Do_spm 
/Разрешить адресацию области RWW 
ldi spmcrval, A«RWWSRE) | A«SPMEN) 
call Do_spm 
/Передать данные из ОЗУ в буфер страницы 
ldi looplo,low(PAGESIZEB) /Инициализировали счетчик байтов 
ldi loophi,high(PAGESIZEB) 
Wrloop: 
Id rO,Y+ 
Id rl,Y+ 
ldi spmcrval, A«SPMEN) 
call Do_spm 
adiw ZH:ZL,2 
sbiw loophi:looplo,2 
brne Wrloop 
-537- 
